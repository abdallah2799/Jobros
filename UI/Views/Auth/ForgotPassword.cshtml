@{
    ViewData["Title"] = "Forgot Password";
}

<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow" style="width: 420px; border-radius: 25px; border: 2px solid #ccc;">

        <!-- Header -->
        <div class="card-header text-center"
             style="background: linear-gradient(45deg, #00B074, #00B074); border-radius: 25px 25px 0 0;">
            <h4 class="fw-bold mb-0" style="color:black;">Forgot Your Password?</h4>
        </div>

        <!-- Body -->
        <div class="card-body p-4" style="color:black;">
            <p class="text-center mb-4">
                Enter your registered email address below.<br>
                We'll send you a link to reset your password.
            </p>

            <form asp-action="ForgotPassword" asp-controller="Auth" method="post" id="forgotPasswordForm">
                @Html.AntiForgeryToken()

                <!-- Email -->
                <div class="mb-3">
                    <label for="Email" class="form-label fw-semibold">Registered Email</label>
                    <input type="email" class="form-control" id="Email" name="email"
                           placeholder="Enter your registered email" required>
                    <div id="emailError" class="text-danger small mt-1"></div>
                </div>

                <!-- Submit -->
                <div class="d-grid mt-4">
                    <button type="submit"
                            id="sendBtn"
                            class="btn btn-lg"
                            style="font-size: 1.1rem;
                                   background: linear-gradient(45deg, #00B074, #00B074);
                                   border: 2px solid #00B074;
                                   color: white;
                                   border-radius: 15px;">
                        Send Reset Link
                    </button>
                </div>

                <!-- Back to Login -->
                <div class="mt-3 text-center" style="font-size: 0.9rem;">
                    <span>Remember your password?</span>
                    <a asp-controller="Auth" asp-action="Login"
                       style="color:#00B074; font-weight:600;">Login</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const emailInput = document.getElementById("Email");
            const form = document.getElementById("forgotPasswordForm");
            const sendBtn = document.getElementById("sendBtn");
            const emailError = document.getElementById("emailError");

            // 🔹 AJAX check if email exists
            emailInput.addEventListener("blur", async function () {
                const email = emailInput.value.trim();
                if (!email) return;

                try {
                    const response = await fetch(`/Auth/CheckEmailExists?email=${encodeURIComponent(email)}`);
                    const data = await response.json();

                    if (!data.exists) {
                        emailError.textContent = "❌ No account found with this email.";
                        emailInput.classList.add("is-invalid");
                        sendBtn.disabled = true;
                    } else {
                        emailError.textContent = "";
                        emailInput.classList.remove("is-invalid");
                        sendBtn.disabled = false;
                    }
                } catch (err) {
                    console.error("Email check failed:", err);
                    showToast("Email check failed. Please try again.", "danger");
                }
            });

            // 🔹 On form submit
            form.addEventListener("submit", function (e) {
                const email = emailInput.value.trim();
                const emailPattern = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;

                if (!emailPattern.test(email)) {
                    e.preventDefault();
                    showToast("❌ Please enter a valid email address.", "error");
                    return;
                }

                showToast("📨 Sending password reset link...", "info");
            });
        });
    </script>
}
