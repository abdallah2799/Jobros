@model Core.DTOs.Auth.UserRegisterDTO
@{
    ViewData["Title"] = "Register";
}

<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow" style="width: 700px; border-radius: 25px; border: 2px solid #ccc;">
        <!-- Header -->
        <div class="card-header text-center"
             style="background:linear-gradient(45deg,#00B074,#00B074);border-radius:25px 25px 0 0;">
            <h4 class="fw-bold mb-0" style="color:black;">Create Your Account</h4>
        </div>

        <div class="card-body p-4" style="color:black;">

            <!-- ================== Phase 1 : Role selection ================== -->
            <div id="phase1" class="text-center">
                <h5 class="fw-semibold mb-4">I want to register as:</h5>
                <div class="d-flex justify-content-center gap-3">
                    <button type="button" class="btn btn-outline-success px-4" id="chooseJobSeeker">Job Seeker</button>
                    <button type="button" class="btn btn-outline-primary px-4" id="chooseEmployer">Employer</button>
                </div>
            </div>

            <!-- ================== Phase 2 : Actual Form ================== -->
            <form asp-action="Register" asp-controller="Auth" method="post" id="register-form" style="display:none;">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="Role" id="Role" />

                <div id="commonFields" class="row g-3 mt-2">
                    <!-- Full name -->
                    <div class="col-md-6">
                        <label asp-for="FullName" class="form-label fw-semibold"></label>
                        <input asp-for="FullName" class="form-control" placeholder="Enter your full name" required />
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>

                    <!-- Email -->
                    <div class="col-md-6">
                        <label asp-for="Email" class="form-label fw-semibold"></label>
                        <input asp-for="Email" class="form-control" placeholder="Enter your email" required />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>

                    <!-- Password -->
                    <div class="col-md-6">
                        <label asp-for="Password" class="form-label fw-semibold"></label>
                        <input asp-for="Password" class="form-control" type="password" placeholder="Enter your password" required />
                        <span asp-validation-for="Password" class="text-danger"></span>
                    </div>

                    <!-- Confirm Password -->
                    <div class="col-md-6">
                        <label asp-for="ConfirmPassword" class="form-label fw-semibold"></label>
                        <input asp-for="ConfirmPassword" class="form-control" type="password" placeholder="Re-enter your password" required />
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    </div>
                </div>

                <!-- ============ Employer-specific ============ -->
                <div id="employerFields" class="row g-3 mt-2" style="display:none;">
                    <div class="col-md-6">
                        <label asp-for="CompanyName" class="form-label fw-semibold"></label>
                        <input asp-for="CompanyName" class="form-control" placeholder="Company name" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Industry" class="form-label fw-semibold"></label>
                        <input asp-for="Industry" class="form-control" placeholder="Industry (e.g. IT, Marketing)" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Website" class="form-label fw-semibold"></label>
                        <input asp-for="Website" class="form-control" placeholder="Company website" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Location" class="form-label fw-semibold"></label>
                        <input asp-for="Location" class="form-control" placeholder="Location / City" />
                    </div>
                    <div class="col-12">
                        <label asp-for="Description" class="form-label fw-semibold"></label>
                        <textarea asp-for="Description" class="form-control" rows="2" placeholder="Short company description"></textarea>
                    </div>
                </div>

                <!-- ============ JobSeeker-specific ============ -->
                <div id="jobSeekerFields" class="row g-3 mt-2" style="display:none;">
                    <div class="col-md-6">
                        <label asp-for="Bio" class="form-label fw-semibold"></label>
                        <textarea asp-for="Bio" class="form-control" rows="2" placeholder="Tell employers about yourself"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Skills" class="form-label fw-semibold"></label>
                        <input asp-for="Skills" class="form-control" placeholder="Your main skills" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="ExperienceYears" class="form-label fw-semibold">Years of Experience</label>
                        <input asp-for="ExperienceYears" type="number" class="form-control" min="0" />
                    </div>
                </div>

                <!-- Terms -->
                <div class="col-12 form-check mt-3">
                    <input type="checkbox" class="form-check-input" id="Terms" required>
                    <label class="form-check-label" for="Terms">
                        I agree to the <a href="#" style="color:#00B074;text-decoration:none;">Terms of Service</a> and
                        <a href="#" style="color:#00B074;text-decoration:none;">Privacy Policy</a>
                    </label>
                </div>

                <!-- Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary px-4" id="backBtn">Back</button>
                    <button type="submit" class="btn btn-success px-4">Register</button>
                </div>
            </form>

            <!-- Already have account -->
            <div class="mt-3 text-center" style="font-size:0.9rem;">
                <span>Already have an account?</span>
                <a asp-controller="Auth" asp-action="Login" style="color:#00B074;font-weight:600;">Login</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const phase1 = document.getElementById("phase1");
        const form = document.getElementById("register-form");
        const employerFields = document.getElementById("employerFields");
        const jobSeekerFields = document.getElementById("jobSeekerFields");
        const roleInput = document.getElementById("Role");
        const chooseEmployer = document.getElementById("chooseEmployer");
        const chooseJobSeeker = document.getElementById("chooseJobSeeker");
        const backBtn = document.getElementById("backBtn");
        const emailInput = document.getElementById("Email");
        const registerBtn = form.querySelector("button[type='submit']");

        // Phase switching
        chooseEmployer.addEventListener("click", () => {
            phase1.style.display = "none";
            form.style.display = "block";
            employerFields.style.display = "flex";
            jobSeekerFields.style.display = "none";
            roleInput.value = "Employer";
        });

        chooseJobSeeker.addEventListener("click", () => {
            phase1.style.display = "none";
            form.style.display = "block";
            employerFields.style.display = "none";
            jobSeekerFields.style.display = "flex";
            roleInput.value = "JobSeeker";
        });

        backBtn.addEventListener("click", () => {
            phase1.style.display = "block";
            form.style.display = "none";
            employerFields.style.display = "none";
            jobSeekerFields.style.display = "none";
            roleInput.value = "";
        });

        // ========== ✅ AJAX Email Availability Check ==========
        emailInput.addEventListener("blur", function () {
            const email = emailInput.value.trim();
            if (!email) return;

            fetch(`/Auth/CheckEmailExists?email=${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        emailInput.classList.add("is-invalid");
                        if (!document.getElementById("emailError")) {
                            const error = document.createElement("div");
                            error.id = "emailError";
                            error.className = "text-danger small mt-1";
                            error.textContent = "❌ This email is already registered.";
                            emailInput.insertAdjacentElement("afterend", error);
                        }
                        registerBtn.disabled = true;
                        showToast("This email is already registered.", "warning");
                    } else {
                        emailInput.classList.remove("is-invalid");
                        const existingError = document.getElementById("emailError");
                        if (existingError) existingError.remove();
                        registerBtn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error("Email check failed:", err);
                    showToast("Email check failed. Please try again.", "danger");
                });
        });

        // ========== ✅ Full Form Validation ==========
        form.addEventListener("submit", (e) => {
            const password = document.getElementById("Password").value.trim();
            const confirmPassword = document.getElementById("ConfirmPassword").value.trim();
            const terms = document.getElementById("Terms").checked;

            // Required field check
            const visibleInputs = form.querySelectorAll("input, textarea, select");
            const emptyFields = [];
            visibleInputs.forEach(input => {
                const isHidden = input.offsetParent === null;
                if (isHidden) return;
                if (input.hasAttribute("required") && !input.value.trim()) {
                    emptyFields.push(input);
                    input.classList.add("is-invalid");
                } else {
                    input.classList.remove("is-invalid");
                }
            });

            if (emptyFields.length > 0) {
                e.preventDefault();
                showToast("Please fill in all required fields.", "warning");
                emptyFields[0].focus();
                return;
            }

            if (password !== confirmPassword) {
                e.preventDefault();
                showToast("Passwords do not match.", "danger");
                return;
            }

            if (!terms) {
                e.preventDefault();
                showToast("You must accept the Terms and Conditions.", "warning");
                return;
            }
        });
    </script>
}




